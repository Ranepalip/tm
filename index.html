<!doctype html><meta charset="utf-8">
<title>Teachable Machine — Demo</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<h3>Проверка модели</h3>
<button id="btn">Камера</button>
<input type="file" id="file" accept="image/*">
<div id="pred">Загружаю модель…</div>
<div id="cam"></div>

<script>
let model, webcam, raf;

// Грузим ЛОКАЛЬНЫЕ файлы из репозитория
(async () => {
  try {
    model = await tmImage.load("model.json", "metadata.json");
    pred.textContent = "Модель загружена. Выберите файл или запустите камеру.";
  } catch (e) {
    pred.textContent = "Ошибка загрузки модели (см. Console)";
    console.error(e);
  }
})();

// Картинка из файла
file.onchange = async e => {
  if (!model) return;
  const f = e.target.files?.[0]; if (!f) return;
  const img = new Image();
  img.onload = async () => render(await model.predict(img));
  img.onerror = () => pred.textContent = "Не удалось прочитать файл";
  img.src = URL.createObjectURL(f);
};

// Камера
btn.onclick = async () => {
  if (!model) return;
  try {
    webcam = new tmImage.Webcam(224,224,true);
    await webcam.setup(); await webcam.play();
    cam.innerHTML = ""; cam.appendChild(webcam.canvas);
    loop();
  } catch (e) { pred.textContent = "Камера недоступна: " + e; console.error(e); }
};

async function loop(){ webcam.update(); render(await model.predict(webcam.canvas)); raf=requestAnimationFrame(loop); }
function render(ps){ pred.innerHTML = ps.map(p=>`${p.className}: ${(p.probability*100).toFixed(1)}%`).join("<br>"); }
addEventListener("beforeunload", ()=>{ if (raf) cancelAnimationFrame(raf); if (webcam) webcam.stop(); });
</script>
